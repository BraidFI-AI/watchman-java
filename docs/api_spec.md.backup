# API Reference

REST API endpoints for sanctions screening against global watchlists (OFAC, EU, UK, UN). All endpoints return JSON unless otherwise specified.

**Base URL:** `http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com`  
**Local Development:** `http://localhost:8080`

**API Version:** v1 (all endpoints prefixed with `/v1`)

---

## Quick Navigation

- [Health & Info](#health--info) - Service health and list information
- [Search](#search) - Single entity screening with fuzzy matching
- [Batch Screening](#batch-screening) - Bulk screening (up to 1,000 entities)
- [Data Management](#data-management) - Download and refresh sanctions data
- [Score Reports](#score-reports) - Detailed scoring breakdowns and trace analysis

---

## Health & Info

### GET /v1/health

Service health check. Returns status and entity count.

**Request:**
```bash
curl http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/health
```

**Response:**
```json
{
  "status": "UP",
  "ofacEntitiesLoaded": 18511,
  "timestamp": "2026-01-22T12:00:00Z"
}s

**Basic search:**
```bash
curl "http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/search?name=Nicolas%20Maduro"
```

**With filters and lower threshold:**
```bash
curl "http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/search?name=Putin&type=person&source=OFAC_SDN&minMatch=0.85&limit=5"
```

**With ScoreTrace (see [Score Reports](#score-reports)):**
```bash
curl "http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/search?name=Nicolas%20Maduro&trace=true"
```

### Response Format

```json
{
  "entities": [
    {
      "id": "23647",
      "name": "WEI, Zhao",
      "type": "PERSON",
      "source": "US_OFAC",
      "sourceId": "23647",
      "score": 0.8710133333333333,
      "altNames": [
        "WEI, Zhang",
        "WAI, Chio",
        "CHIO, Wai",
        "WEI, Chao",
        "WEI, Jiao",
        "HWEI, Jao",
        "SAECHOU, Thanchai"
      ],
      "programs": [
        "TCO"
      ],
      "breakdown": null
    },
    {
      "id": "6861",
      "name": "GUZMAN LOERA, Joaquin",
      "type": "PERSON",
      "source": "US_OFAC",
      "sourceId": "6861",
      "score": 0.8555555555555555,
      "altNames": [
        "AREGON, Max",
        "GUZMAN, Chapo",
        "GUIERREZ LOERA, Jose Luis",
        "GUZMAN FERNANDEZ, Joaquin",
        "GUZMAN LOESA, Joaquin",
        "GUZMAN PADILLA, Joaquin",
        "GUMAN LOERAL, Joaquin",
        "GUZMAN, Archibaldo",
        "GUZMAN, Aureliano",
        "ORTEGA, Miguel",
        "RAMIREZ, Joise Luis",
        "CARO RODRIGUEZ, Gilberto",
        "GUZMAN, Joaquin Chapo",
        "GUZMAN LOREA, Chapo",
        "GUZMAN LOEIA, Joaguin",
        "GUZMAN, Achivaldo",
        "OSUNA, Gilberto",
        "RAMOX PEREZ, Jorge"
      ],
      "programs": [
        "SDNTK"
      ],
      "breakdown": null
    }
  ],
  "totalResults": 2,
  "requestID": null,
  "debug": null,
  "trace": null,
  "reportUrl": null
}
```
| Field | Type | Description |
|-------|------|-------------|
| status | string | `UP` or `DOWN` |
| ofacEntitiesLoaded | int | Total entities loaded in memory |
| timestamp | string | ISO-8601 timestamp |

---

### GET /v1/listinfo

Get available sanctions lists and entity counts per list.

**Request:**
```bash
curl http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/listinfo
```

**Response:**
```json
{
  "lists": [
    {
      "name": "OFAC_SDN",
      "description": "US Treasury Specially Designated Nationals",
      "entityCount": 12543,
      "lastUpdated": "2026-01-22T08:00:00Z"
    },
    {
      "name": "US_CSL",
      "description": "US Consolidated Screening List",
      "entityCount": 8012,
      "lastUpdated": "2026-01-22T08:00:00Z"
    },
    {
      "name": "EU_CSL",
      "description": "EU Consolidated Sanctions List",
      "entityCount": 4856,
      "lastUpdated": "2026-01-22T08:00:00Z"
    },
    {
      "name": "UK_CSL",
      "description": "UK Consolidated Sanctions List",
      "entityCount": 2987,
      "lastUpdated": "2026-01-22T08:00:00Z"
    }
  ],
  "totalEntities": 18511
}
```

**Use Cases:**
- Verify data loaded after refresh
- Check which lists are available for filtering
- Monitor entity counts for data quality

---

## Search

### GET /v1/search

Search for a single entity against OFAC sanctions lists.

### Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| name | string | Yes | - | Primary entity name to search |
| altNames | string[] | No | - | Alternate names (comma-separated) |
| minMatch | double | No | 0.88 | Minimum match score (0.0-1.0) |
| limit | int | No | 10 | Maximum results to return |
| type | string | No | - | Entity type filter: person, business, organization, aircraft, vessel |
| source | string | No | - | Source filter: US_OFAC, EU_CSL, UK_CSL, UN_CSL |
| trace | boolean | No | false | Enable scoring trace capture |
| requestID | string | No | - | Request correlation ID |

### Request Example

```bash
curl "http://localhost:8080/v1/search?name=Nicolas%20Maduro&minMatch=0.85&limit=5&trace=true"
```

### Response Format

```json
{
  "entities": [
    {
      "id": "23647",
      "name": "WEI, Zhao",
      "type": "PERSON",
      "source": "US_OFAC",
      "sourceId": "23647",
      "score": 0.8710133333333333,
      "altNames": [
        "WEI, Zhang",
        "WAI, Chio",
        "CHIO, Wai",
        "WEI, Chao",
        "WEI, Jiao",
        "HWEI, Jao",
        "SAECHOU, Thanchai"
      ],
      "programs": [
        "TCO"
      ],
      "breakdown": null
    },
    {
      "id": "6861",
      "name": "GUZMAN LOERA, Joaquin",
      "type": "PERSON",
      "source": "US_OFAC",
      "sourceId": "6861",
      "score": 0.8555555555555555,
      "altNames": [
        "AREGON, Max",
        "GUZMAN, Chapo",
        "GUIERREZ LOERA, Jose Luis",
        "GUZMAN FERNANDEZ, Joaquin",
        "GUZMAN LOESA, Joaquin",
        "GUZMAN PADILLA, Joaquin",
        "GUMAN LOERAL, Joaquin",
        "GUZMAN, Archibaldo",
        "GUZMAN, Aureliano",
        "ORTEGA, Miguel",
        "RAMIREZ, Joise Luis",
        "CARO RODRIGUEZ, Gilberto",
        "GUZMAN, Joaquin Chapo",
        "GUZMAN LOREA, Chapo",
        "GUZMAN LOEIA, Joaguin",
        "GUZMAN, Achivaldo",
        "OSUNA, Gilberto",
        "RAMOX PEREZ, Jorge"
      ],
      "programs": [
        "SDNTK"
      ],
      "breakdown": null
    }
  ],
  "totalResults": 2,
  "requestID": null,
  "debug": null,
  "trace": null,
  "reportUrl": null
}
```

### Response Fields

| Field | Type | Description |
|-------|------|-------------|
| entities | array | Array of matching entities |
| entities[].id | string | Internal entity identifier |
| entities[].name | string | Primary entity name |
| entities[].type | string | Entity type (PERSON, BUSINESS, ORGANIZATION, AIRCRAFT, VESSEL) |
| entities[].source | string | Data source (US_OFAC, EU_CSL, UK_CSL, UN_CSL) |
| entities[].sourceId | string | Source-specific entity ID |
| entities[].score | double | Match score (0.0-1.0) |
| entities[].altNames | string[] | Alternate names |
| entities[].programs | string[] | Sanctions programs |
| entities[].breakdown | object | Component score breakdown (only when trace=true, otherwise null) |
| totalResults | int | Total number of matches found |
| requestID | string | Request correlation ID (null if not provided) |
| debug | object | Debug information (null unless debug=true) |
| trace | object | Trace metadata with sessionId and durationMs (null unless trace=true) |
| reportUrl | string | URL to HTML trace report (null unless trace=true) |
        "totalWeightedScore": 0.95
      }
    }
  ],
  "totalResults": 1,
  "requestID": "abc-123",
  "debug": null,
  "trace": {
    "sessionId": "trace-abc-123",
    "durationMs": 45
  },
  "reportUrl": "/api/reports/trace-abc-123"
}
```

### Response Fields

| Field | Type | Description |
|-------|------|-------------|
| entities | array | Array of matching entities |
| totalResults | int | Total number of matches |
| requestID | string | Request correlation ID (null if not provided) |
| debug | object | Debug information (null unless debug mode) |
| trace | object | Trace metadata with sessionId and durationMs (null unless trace=true) |
| reportUrl | string | URL to HTML trace report (null unless trace=true) |

### Entity Fields

| Field | Type | Description |
|-------|------|-------------|
| id | string | Internal entity identifier |
| name | string | Primary entity name |
| type | string | Entity type (PERSON, BUSINESS, ORGANIZATION, AIRCRAFT, VESSEL) |
| source | string | Data source (US_OFAC, EU_CSL, UK_CSL, UN_CSL) |
| sourceId | string | Source-specific entity ID |
| score | double | Match score (0.0-1.0) |
| altNames | string[] | Alternate names |
| addresses | object[] | Physical addresses (optional) |
| governmentIds | object[] | National IDs, passports, TINs (optional) |
| dateOfBirth | string | ISO-8601 date YYYY-MM-DD (optional) |
| placeOfBirth | string | Birth location (optional) |
| programs | string[] | Sanctions programs |
| remarks | string | Additional notes (optional) |
| breakdown | object | Component score breakdown (only when trace=true, otherwise null) |

### Error Responses

**400 Bad Request** - Missing or invalid parameters
```json
{
  "error": "Bad Request",
  "message": "Missing required parameter: name",
  "status": 400,
  "path": "/v1/search",
  "requestId": "abc-123",
  "timestamp": "2026-01-14T12:00:00Z"
}
```

**500 Internal Server Error** - Server error
```json
{
  "error": "Internal Server Error",
  "message": "Failed to load OFAC data",
  "status": 500,
  "path": "/v1/search",
  "requestId": "abc-123",
  "timestamp": "2026-01-14T12:00:00Z"
}
```

---

## POST /v1/search/batch

Screen multiple entities in a single request (up to 1,000 entities).

### Request Body

```json
{
  "entities": [
    {
      "name": "Vladimir Putin",
      "altNames": ["Putin, Vladimir Vladimirovich"],
      "dateOfBirth": "1952-10-07"
    },
    {
      "name": "Taliban Organization",
      "type": "organization"
    }
  ],
  "minMatch": 0.88,
  "limit": 10
}
```

### Request Fields

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| entities | Entity[] | Yes | - | Array of entities to screen (max 1,000) |
| minMatch | doubles

**Simple batch (3 entities):**
```bash
curl -X POST http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/search/batch \
  -H "Content-Type: application/json" \
  -d '{
    "entities": [
      {"name": "Nicolas Maduro"},
      {"name": "Vladimir Putin"},
      {"name": "Taliban Organization"}
    ],
    "minMatch": 0.85
  }'
```

**With filters:**
```bash
curl -X POST http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/search/batch \
  -H "Content-Type: application/json" \
  -d '{
    "entities": [
      {"name": "John Doe", "type": "person"},
      {"name": "ACME Corp", "type": "business"}
    ],
    "minMatch": 0.9,
    "limit": 5,
    "source": "OFAC_SDN"
  }'
```

**With ScoreTrace:**
```bash
curl -X POST http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/search/batch \
  -H "Content-Type: application/json" \
  -d '{
    "entities": [{"name": "Nicolas Maduro"}],
    "trace": trues[] | No | Physical addresses |

### Request Example

```bash
curl -X POST http://localhost:8080/v1/search/batch \
  -H "Content-Type: application/json" \
  -d '{
    "entities": [
      {"name": "Nicolas Maduro"},
      {"name": "Vladimir Putin"},
      {"name": "Taliban Organization"}
    ],
    "minMatch": 0.85
  }'
```

### Response Format

```json
{
  "entities": [
    {
      "id": "14121",
      "name": "MADURO MOROS, Nicolas",
      "type": "PERSON",
      "source": "US_OFAC",
      "sourceId": "14121",
      "score": 0.95,
      "altNames": [
        "MADURO, Nicolas",
        "Nicolas Maduro Moros"
      ],
      "programs": [
        "VENEZUELA",
        "SDGT"
      ],
      "breakdown": null
    },
    {
      "id": "13967",
      "name": "PUTIN, Vladimir Vladimirovich",
      "type": "PERSON",
      "source": "US_OFAC",
      "sourceId": "13967",
      "score": 0.98,
      "altNames": [
        "PUTIN, Vladimir",
        "Vladimir Putin"
      ],
      "dateOfBirth": "1952-10-07",
      "programs": [
        "UKRAINE-EO13661",
        "RUSSIA-EO14024"
      ],
      "breakdown": null
    },
    {
      "id": "23789",
      "name": "TALIBAN",
      "type": "ORGANIZATION",
      "source": "US_OFAC",
      "sourceId": "23789",
      "score": 0.92,
      "altNames": [
        "Islamic Emirate of Afghanistan",
        "Taleban"
      ],
      "programs": [
        "SDGT",
        "AFGHANISTAN"
      ],
      "breakdown": null
    }
  ],
  "totalResults": 3,
  "requestID": null,
  "debug": null,
  "trace": null,
  "reportUrl": null
}
  # GET /v1/search/batch/config

Get batch screening configuration limits.

**Request:**
```bash
curl http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/search/batch/config
```

**Response:**
**Request:**
```bash
curl http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/api/reports/trace-abc-123 > report.html
```

**Response:** HTML page with:
- Visual score breakdown by component
- Phase-by-phase execution details with timing
- Color-coded match indicators
- Complete entity details

**Best For:** Compliance review, audit trails, customer explanations

---

### GET /api/reports/{sessionId}/summary

Get JSON summary of scoring trace for automation.

**Request:**
```bash
curl http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com

### POST /v1/data/refresh

Refresh in-memory sanctions data. Reloads entities from downloaded files into the search index.

**Request:**
```bash
curl -X POST http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/data/refresh
```

**Response:**
```json
{
  "status": "SUCCESS",
  "entitiesLoaded": 18511,
  "durationMs": 2453,
  "timestamp": "2026-01-22T12:00:00Z",
  "message": "Data refresh completed successfully"
}
```

**Use Case:** Reload data after downloading updated sanctions lists without restarting the service.

---

### GET /v1/data/status

Get data download and refresh status.

**Request:**
```bash
curl http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/data/status
```

**Response:**
```json
{
  "lastDownload": "2026-01-22T08:00:00Z",
  "lastRefresh": "2026-01-22T08:05:00Z",
  "entitiesLoaded": 18511,
  "dataSource": "https://www.treasury.gov/ofac/downloads/sdn.xml",
**Best For:** Dashboards, performance monitoring, automated analysis

**Insights Examples:**
- "Name comparison was primary match factor (score: 0.95)"
- "Address data not available for comparison"
- "Government ID exact match found (instant 1.0 score)"
- "Processing completed in 45ms"

**Report Retention:** 24 hours (in-memory storage). Reports expire after 24 hours.

### Workflow

**Step 1:** Search with `trace=true`

```bash
curl "http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/search?name=Nicolas%20Maduro&trace=true"
```

**Response includes:**
```json
{
  "entities": [...],
  "trace": {
    "sessionId": "trace-abc-123",
    "durationMs": 45,
    "reportUrl": "/api/reports/trace-abc-123"
  }
}
```

**Step 2a:** Get HTML report (for humans)

```bash
curl http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/api/reports/trace-abc-123 > report.html
open report.html
```

**Step 2b:** Get JSON summary (for automation)

```bash
curl http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/api/reports/trace-abc-123/summary
```

---

### GET /api/reports/{sessionId}

Get HTML trace report with visual score breakdow
        }
      ],
      "matchCount": 1
    }
  ],
  "totalEntities": 2,
  "totalMatches": 2,
  "processingTimeMs": 123
}
```

###ScoreTrace Best Practices

**When to Enable Trace:**
- ✅ Debugging unexpected match results
- ✅ Compliance audit trails
- ✅ Threshold tuning (run sample queries to analyze score distribution)
- ✅ Performance optimization (identify slow phases)
- ❌ Production high-volume screening (adds overhead)
- ❌ Every request (traces consume memory)

**Performance Impact:**
- Adds ~5-10ms per request
- Traces stored in memory for 24 hours
- Batch requests: trace applies to all entities (can be large)

**Trace Scenarios:**

| Scenario | Use HTML Report | Use JSON Summary |
|----------|----------------|------------------|
| Customer asks "Why did this match?" | ✅ | ❌ |
| Compliance audit review | ✅ | ❌ |
| Performance dashboard | ❌ | ✅ |
| Automated alerting | ❌ | ✅ |
| Threshold tuning analysis | ❌ | ✅ |
| Developer debugging | ✅ | ✅ |

---

## Testing

**Run integration tests:**
```bash
./mvnw test -Dtest=SearchApiIntegrationTest
```

**Test live API:**
```bash
# Health check
curl http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/health

# Simple search
curl "http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/search?name=Putin"

# With trace
curl "http://watchman-java-alb-1239419410.us-east-1.elb.amazonaws.com/v1/search?name=Putin&trace=true"
```

**Postman Collection:**
Import from: `https://raw.githubusercontent.com/BraidFI-AI/watchman-java/main/postman/Watchman-Java-API.postman_collection.json400 Bad Request** - Invalid input
```json
{
  "error": "Bad Request",
  "message": "Batch size exceeds maximum: 1000",
  "status": 400,
  "path": "/v1/search/batch",
  "requestId": "abc-123",
  "timestamp": "2026-01-14T12:00:00Z"
}
```

---

## GET /api/reports/{sessionId}

Retrieve HTML score report for a trace session.

### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| sessionId | string | Yes | Trace session ID from search response |

### Request Example

```bash
curl http://localhost:8080/api/reports/trace-abc-123 > report.html
```

### Response

Returns HTML page with visual score breakdown, phase-by-phase execution details, and timing information. Suitable for compliance review and audit trails.

---

## GET /api/reports/{sessionId}/summary

Retrieve JSON summary of scoring trace.

### Request Example

```bash
curl http://localhost:8080/api/reports/trace-abc-123/summary
```

### Response Format

```json
{
  "sessionId": "trace-abc-123",
  "totalEntitiesScored": 1,
  "durationMs": 45,
  "phaseContributions": {
    "NAME_COMPARISON": 0.95,
    "ALT_NAME_COMPARISON": 0.0,
    "ADDRESS_COMPARISON": 0.0,
    "GOV_ID_COMPARISON": 0.0,
    "DATE_COMPARISON": 0.0,
    "AGGREGATION": 0.95
  },
  "phaseTimings": {
    "NAME_COMPARISON": 2,
    "AGGREGATION": 1,
    "total": 45
  },
  "slowestPhase": "NAME_COMPARISON",
  "insights": [
    "Name comparison was primary match factor (score: 0.95)",
    "No address data available for comparison",
    "Processing completed in 45ms"
  ]
}
```

### Response Fields

| Field | Type | Description |
|-------|------|-------------|
| sessionId | string | Trace session ID |
| totalEntitiesScored | int | Number of entities scored |
| durationMs | long | Total processing time |
| phaseContributions | Map<String, Double> | Score contribution per phase |
| phaseTimings | Map<String, Long> | Duration per phase (ms) |
| slowestPhase | string | Phase with longest duration |
| insights | string[] | Human-readable insights |

---

## GET /v1/health

Health check endpoint.

### Request Example

```bash
curl http://localhost:8080/v1/health
```

### Response Format

```json
{
  "status": "UP",
  "ofacEntitiesLoaded": 18511,
  "timestamp": "2026-01-14T12:00:00Z"
}
```

### Response Fields

| Field | Type | Description |
|-------|------|-------------|
| status | string | Service status: "UP" or "DOWN" |
| ofacEntitiesLoaded | int | Number of OFAC entities loaded |
| timestamp | string | ISO-8601 timestamp |

---

## Common Headers

### Request Headers

| Header | Required | Description |
|--------|----------|-------------|
| Content-Type | Yes (POST) | application/json |
| X-Request-ID | No | Request correlation ID |

### Response Headers

| Header | Always Present | Description |
|--------|----------------|-------------|
| Content-Type | Yes | application/json |
| X-Request-ID | If provided | Echoed request ID |

---

## Rate Limiting

Currently no rate limiting enforced. For production deployment, consider:
- Rate limits per IP/API key
- Batch size limits (current: 1,000 entities)
- Concurrent request limits

---

## Testing

```bash
# Run API tests
./mvnw test -Dtest=SearchControllerTest

# Test live deployment
./scripts/test-live-api.sh

# Load testing
./scripts/load-test-simple.sh 100
```
